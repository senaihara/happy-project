<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset=utf-8>
  <meta name="viewport" content="width=device-width,initial-scale=1.0, user-scalable=yes">
  <title>Html5 位置情報</title>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?callback=initMap" async defer></script>
<script>
    //オブジェクトクラス定義
    class WalkerObj {
        constructor(id=0, posLat=0, posLong=0, posAlt=0, angle=0, type=0, owner=0, statusFg=0, enableFg=1, viewFg=1, deleteFg=0){
            this.id = id;
            this.posLat = posLat;
            this.posLong = posLong;
            this.posAlt = posAlt;
            this.angle = angle;
            this.type = type;
            this.owner = owner;
            this.statusFg = statusFg;
            this.enableFg = enableFg;
            this.viewFg = viewFg;
            this.deleteFg = deleteFg;
        }
        
        print(){
            log("id="+this.id);
        }
    }

    var gCharaCurPos = {};
    var gCharaMapObj = {};
    var gCharaPutObj = {};
    var gDevice = null;
    var gService = {};
    var gLati;
    var gLong; 
    var gMyId = 1;    
    var gAngle = 0;
    var gAlt = 0;
    var gGattModeFg=0;
    var gMyObj = new WalkerObj();
    gMyObj.id = 1;
    var gObjList = new Array();
    var gCount=1;
     
    function initMap() {             // google maps Javascript と同期
        if (navigator.geolocation) {   // 現在の位置情報を取得する
          //navigator.geolocation.getCurrentPosition(successCallback, errorCallback,option);
          navigator.geolocation.getCurrentPosition(successCallback, errorCallback,
            {                 // 位置取得オプション
            "enableHighAccuracy":true,
            "timeout":8000,
            "maximumAge":60000,
            });
        } else {
          alert('navigator.geolocation は利用出来ません');
        }  
    }; //  initMap()  --------------
      
      // 現在の位置情報を取得時の処置  ------------------
    function successCallback(position) {
        var lati = position.coords.latitude.toFixed(5);
        var long = position.coords.longitude.toFixed(5);
        gMyObj.pos_lat = position.coords.latitude.toFixed(5);
        gMyObj.pos_long = position.coords.longitude.toFixed(5);
        gMyObj.pos_alt = position.coords.altitude;
        if(gMyObj.pos_alt == null) gMyObj.pos_alt = 0;
        
        var g_txt = "緯度：" + gLati + "<br>";
        g_txt += "経度：" + gLong + "<br>";  
        g_txt += "同精度：" + position.coords.accuracy + " m<br>";
        g_txt += "高度：" + position.coords.altitude + " m<br>";
        document.getElementById("txt_result").innerHTML = g_txt; // 位置の書き出し
        // Google Mapsに書き出し ------------------
        var latlng = new google.maps.LatLng( lati,long );        // 地図の中心
        var mapobj = new google.maps.Map( document.getElementById('gmap'), {
            zoom: 15 ,
            center:latlng
        });
        new google.maps.Marker( { map:mapobj , position:latlng } );  // マーカーセット
      }; //  successCallback(position) ---------------
 
      // 位置情報が取得できない場合の処置 ---------------
    function errorCallback(error) {
        var err_msg = "";
        switch(error.code){
          case 0:
            err_msg = "原因不明のエラーが発生しました";
            break;
          case 1:
            err_msg = "位置情報の利用が許可されていません";
            break;
          case 2:
            err_msg = "デバイスの位置が取得できません";
            break;
          case 3:
            err_msg = "タイムアウトしました";
            break;
        }
        document.getElementById("txt_result").innerHTML = err_msg;
      }; //  errorCallback(error) ----------------------

    $(function() {
        //initialize
        //初期設定
        /* 
        setInterval(function(){
            if(gGattModeFg%2==0){
                log("updatePos")
                updateCurPos();
            }else{
                log("getRadarAngle")
                getRadarAngle();
            } 
           gGattModeFg++;
        },5000);
        */  
        $('#ble_connect').click(function(){
           //alert('connect')
            const SERVICE_UUID =0x0d18;
            const CHARA_UUID_CUR_POS = 0x2a33;
            const CHARA_UUID_MAP_OBJ = 0x2a34;
            const CHARA_UUID_PUT_OBJ = 0x2a35;
            navigator.bluetooth.requestDevice({filters: [{services: [SERVICE_UUID]}]})
            .then(device => {
                log('Connecting to GATT Server...');
                gDevice = device;
                return device.gatt.connect();
            })
            .then(server => {
                log('Getting Service...');
                return server.getPrimaryService(SERVICE_UUID);
            })
            .then(service => {
                gService = service;
                log('Getting Characteristic...');
                
                service.getCharacteristic(CHARA_UUID_CUR_POS).then(characteristic => {
                    gCharaCurPos = characteristic;    
                    log('> Characteristic UUID:  ' + characteristic.uuid);
                
                });
                
                service.getCharacteristic(CHARA_UUID_MAP_OBJ).then(characteristic => {
                    gCharaMapObj = characteristic;
                    log('> Characteristic UUID:  ' + characteristic.uuid);
                });
                
               return service.getCharacteristic(CHARA_UUID_PUT_OBJ).then(characteristic => {
                    gCharaPutObj = characteristic;
                log('> Characteristic UUID:  ' + characteristic.uuid);
                log('> Broadcast:            ' + characteristic.properties.broadcast);
                log('> Read:                 ' + characteristic.properties.read);
                log('> Write w/o response:   ' +
                      characteristic.properties.writeWithoutResponse);
                log('> Write:                ' + characteristic.properties.write);
                log('> Notify:               ' + characteristic.properties.notify);
                log('> Indicate:             ' + characteristic.properties.indicate);
                log('> Signed Write:         ' +
                      characteristic.properties.authenticatedSignedWrites);
                log('> Queued Write:         ' + characteristic.properties.reliableWrite);
                log('> Writable Auxiliaries: ' +
                      characteristic.properties.writableAuxiliaries);
  
                    return gCharaPutObj.startNotifications().then(_ => {
                        log('> Notifications started');
                        gCharaPutObj.addEventListener('characteristicvaluechanged',
                        function(event){
                            let value = event.target.value;
                            let a = [];
                            for (let i = 0; i < value.byteLength; i++) {
                                //a.push('0x' + ('00' + value.getUint8(i).toString(16)).slice(-2));
                                a.push(value.getUint8(i).toString(16));
                            }
                            log('> notify ' + a.join(' '));
                            
                            var buffer = new ArrayBuffer(4);
                            
                            var dataView = new DataView(buffer);
                            dataView.setUint8(0, parseInt(value.getUint8(0).toString(16),16));
                            dataView.setUint8(1, parseInt(value.getUint8(1).toString(16),16));
                            dataView.setUint8(2, parseInt(value.getUint8(2).toString(16),16));
                            dataView.setUint8(3, parseInt(value.getUint8(3).toString(16),16));
                            var putObjLati = dataView.getFloat32(0, true);
                            
                            dataView.setUint8(0, parseInt(value.getUint8(4).toString(16),16));
                            dataView.setUint8(1, parseInt(value.getUint8(5).toString(16),16));
                            dataView.setUint8(2, parseInt(value.getUint8(6).toString(16),16));
                            dataView.setUint8(3, parseInt(value.getUint8(7).toString(16),16));
                            var putObjLong = dataView.getFloat32(0, true);
                              
                            log("covert pos lati="+putObjLati+" long="+putObjLong+ " type="
                            +value.getUint8(8).toString(16)+" owner="+value.getUint8(9).toString(16));
                            var putObj = new WalkerObj();
                            putObj.posLat = putObjLati;
                            putObj.posLong = putObjLong;
                            putObj.type = value.getUint8(8).toString(16);
                            putObj.owner = value.getUint8(9).toString(16);
                            
                            putObjToDB(putObj);
                            
                        
                        
                        });
                        
                        
                        //handleNotifications);
                    });

               });

            })
            /*
           .then(characteristic => {
                log('> Characteristic UUID:  ' + characteristic.uuid);
                log('> Broadcast:            ' + characteristic.properties.broadcast);
                log('> Read:                 ' + characteristic.properties.read);
                log('> Write w/o response:   ' +
                      characteristic.properties.writeWithoutResponse);
                log('> Write:                ' + characteristic.properties.write);
                log('> Notify:               ' + characteristic.properties.notify);
                log('> Indicate:             ' + characteristic.properties.indicate);
                log('> Signed Write:         ' +
                      characteristic.properties.authenticatedSignedWrites);
                log('> Queued Write:         ' + characteristic.properties.reliableWrite);
                log('> Writable Auxiliaries: ' +
                      characteristic.properties.writableAuxiliaries);
  
                gCharaCurPos = characteristic;
                //return gCharaCurPos.startNotifications().then(_ => {
                //    log('> Notifications started');
                //    gCharacteristic.addEventListener('characteristicvaluechanged',
                //    handleNotifications);
                //});
            })*/
        })
  
        $('#ble_read_test').click(function(){
            alert("read test");
            gCharacteristic.readValue()
            .then((val) => {
                let ble_value = val.getUint8(0)
                log('> Characteristic value:  ' + ble_value)               
            })
        })
        
        $('#ble_write_test').click(function(){
     alert("write test");
                    var barr = new Int8Array(1);
                    barr[0]=2;
                      gCharacteristic.writeValue(barr);  
     
                       
    
                                            })
   
	//自分の座標位置の更新                          
        $('#update_pos').click(function(){
            updateCurPos();
        })

        //オブジェクトの追加                          
        $('#update_obj').click(function(){
        
            updateObjs();
            return;
            
            var f1 = new Float32Array(1);
            f1[0] = gLati;
            var arrayLati = new Int8Array(f1.buffer)
          
            var f2 = new Float32Array(1);
            f2[0] = gLong;
            var arrayLong = new Int8Array(f2.buffer);
            
            var d1 = new Int16Array(1);
            d1[0] = 300;
            var arrayAngle = new Int8Array(d1.buffer);
            
            //id[1],lat[4],long[4],angle[2],type[1],owner[1],status[1],enableFg[1],viewFg[1]
                     
            var sendBuf = new Int8Array(16);
            sendBuf[0] = gCount;
            gCount++;
            sendBuf[1] = arrayLati[0];
            sendBuf[2] = arrayLati[1];
            sendBuf[3] = arrayLati[2];
            sendBuf[4] = arrayLati[3];
            sendBuf[5] = arrayLong[0];
            sendBuf[6] = arrayLong[1];
            sendBuf[7] = arrayLong[2];
            sendBuf[8] = arrayLong[3];
            sendBuf[9] = arrayAngle[0];
            sendBuf[10] = arrayAngle[1];
            sendBuf[11] = 1;//type
            sendBuf[12] = 2;//owner
            sendBuf[13] = 3;//status
            sendBuf[14] = 4;//enableFg
            sendBuf[15] = 5;//viewFg
            
            log("update obj sendBuf "+sendBuf);
            gCharaMapObj.writeValue(sendBuf).then(_ => {
            });
            
            return;
        })
  
        $('#ble_disconnect').click(function(){
            alert('disconnect')
            gDevice.gatt.disconnect()
            gDevice = null;
        })

        $('#test').click(function(){
          
          putObjToDB(gMyObj);
          
           
            
            return;
        }) 
    });
    //jQuery end
    
    //Radarへの現在位置の更新
    function updateCurPos2Radar(){
        if(gDevice==null || gCharaCurPos == null){
            log("gDevice or gCharaCurPos = null");
            return;
        }
       /* 
        //先に角度を取得する
        gCharaCurPos.readValue()
        .then((val) => {
            var buffer = new ArrayBuffer(2);
            var dataView = new DataView(buffer);
            dataView.setUint8(0, parseInt(val.getUint8(9).toString(16),16));
            dataView.setUint8(1, parseInt(val.getUint8(10).toString(16),16));
            gAngle = dataView.getUint16(0, true);
            log("gAngle="+gAngle);
        })
        */

        var f1 = new Float32Array(1);
        f1[0] = gLati;
        log(gLati+" "+f1[0])  
        var arrayLati = new Int8Array(f1.buffer)
      
        var f2 = new Float32Array(1);
        f2[0] = gLong;
        var tmpArray = []
        log(gLong+" "+f2[0])
        var arrayLong = new Int8Array(f2.buffer);
                 
        var sendBuf = new Int8Array(9);
        sendBuf[0] = gMyId;
        sendBuf[1] = arrayLati[0];
        sendBuf[2] = arrayLati[1];
        sendBuf[3] = arrayLati[2];
        sendBuf[4] = arrayLati[3];
        sendBuf[5] = arrayLong[0];
        sendBuf[6] = arrayLong[1];
        sendBuf[7] = arrayLong[2];
        sendBuf[8] = arrayLong[3];
        
        gCharaCurPos.writeValue(sendBuf)
        .then(_ => {
        });
    }
    
    function getRadarAngle(){
        if(gDevice==null || gCharaCurPos == null){
            log("gDevice or gCharaCurPos = null");
            return;
        }
        gCharaCurPos.readValue()
        .then((val) => {
            var buffer = new ArrayBuffer(2);
            var dataView = new DataView(buffer);
            dataView.setUint8(0, parseInt(val.getUint8(9).toString(16),16));
            dataView.setUint8(1, parseInt(val.getUint8(10).toString(16),16));
            gAngle = dataView.getUint16(0, true);
            log("gAngle="+gAngle);
        })
    }
    
    function updateCurPos(){ 
        if (navigator.geolocation) {   // 現在の位置情報を取得する
            navigator.geolocation.getCurrentPosition(
            function(position){
                gMyId = 1;
                //gMyId = $('#myId').val();
                gLati = position.coords.latitude.toFixed(5);
                gLong = position.coords.longitude.toFixed(5);
                gAlt = position.coords.altitude;
                if(gAlt==null){
                    gAlt=0;
                }
                
                //Radarへの現在位置の更新
                updateCurPos2Radar();
                
                //サーバへの現在位置の更新 
                $.getJSON('https://160.16.116.250/walker/api/update_cur_pos.php',
                {id:gMyId, pos_lat:gMyObj.pos_lat, pos_long:gMyObj.pos_long, pos_alt:gMyObj.pos_alt, pos_angle:gMyObj.angle })
                .done(function(data) {
                    var len = data.length;
                    for(var i = 0; i < len; i++) {
                        log("get data="+data[i].result);
                    }
                });  
            },
            function(error){
                log("exec update_cur_pos.php error="+error.code);
            },
            //option
            {"enableHighAccuracy":true, "timeout":8000, "maximumAge":60000, }
            );  
        } else {
          alert('navigator.geolocation は利用出来ません');
          return;
        } 
    }
    
    //Radarへのオブジェクトの更新
    function updataObjs2Radar(walkerObj, retryCount){
        var f1 = new Float32Array(1);
        f1[0] = walkerObj.posLat;
        var arrayLati = new Int8Array(f1.buffer)
      
        var f2 = new Float32Array(1);
        f2[0] = walkerObj.posLong;
        var arrayLong = new Int8Array(f2.buffer);
        
        var d1 = new Int16Array(1);
        d1[0] = walkerObj.angle;
        var arrayAngle = new Int8Array(d1.buffer);
        
        //id[1],lat[4],long[4],angle[2],type[1],owner[1],status[1],enableFg[1],viewFg[1]
                 
        var sendBuf = new Int8Array(16);
        sendBuf[0] = walkerObj.id;
        sendBuf[1] = arrayLati[0];
        sendBuf[2] = arrayLati[1];
        sendBuf[3] = arrayLati[2];
        sendBuf[4] = arrayLati[3];
        sendBuf[5] = arrayLong[0];
        sendBuf[6] = arrayLong[1];
        sendBuf[7] = arrayLong[2];
        sendBuf[8] = arrayLong[3];
        sendBuf[9] = arrayAngle[0];
        sendBuf[10] = arrayAngle[1];
        sendBuf[11] = walkerObj.type;//type
        sendBuf[12] = walkerObj.owner;//owner
        sendBuf[13] = walkerObj.statusFg;//status
        sendBuf[14] = walkerObj.enableFg;//enableFg
        sendBuf[15] = walkerObj.viewFg;//viewFg
        
        log("update obj sendBuf "+sendBuf);
        return gCharaMapObj.writeValue(sendBuf)
       .catch(error => {
            retryCount--;
            log("retryCount"+retryCount)
            if (retryCount > 0) {
                return updataObjs2Radar(walkerObj, retryCount);
            }
            log("write error");
            return Promise.reject(error);
        });   
    }
    
    //オブジェクトの更新(DBからobjectを取得してRadarに更新する)
    function updateObjs(){
        //DBからオブジェクトの受信
        //サーバへの現在位置の更新 
        $.getJSON('https://160.16.116.250/walker/api/search_objs.php',
        {id:gMyObj.id})
        .done(function(data) {
            //alert('getdata')
            var len = data.length;
            log("search_obj.php len="+len);
            for(var i = 0; i < len; i++) {
                tmpObj = new WalkerObj(data[i].id, data[i].pos_lat, data[i].pos_long, data[i].pos_alt, data[i].angle, data[i].type, data[i].owner, data[i].status_fg, data[i].enable_fg, data[i].delete_fg);
                
                //check existance
                var fg = 0;
                for(var j=0; j<gObjList.length; j++){
                    if(gObjList[j].id == tmpObj.id){
                        fg = 1;
                        break;
                    }
                }
                //if find continue;
                if(fg){
                    continue;
                }
                gObjList.push(tmpObj);
            }
        }); 
        
        //radarへの更新処理
        for(var i = 0; i < gObjList.length; i++) {
            updataObjs2Radar(gObjList[i], 50);
        }
    }
    
    //DBに対してobjの配置を行う
    function putObjToDB(walkerObj){
        //DBからオブジェクトの受信
        //サーバへの現在位置の更新
        // $.getJSON('https://160.16.116.250/walker/api/update_cur_pos.php',
        //{id:gMyId, pos_lat:gMyObj.pos_lat, pos_long:gMyObj.pos_long, pos_alt:gMyObj.pos_alt, pos_angle:gMyObj.angle })
        $.getJSON('https://160.16.116.250/walker/api/put_obj.php',
        {pos_lat:walkerObj.posLat, pos_long:walkerObj.posLong, pos_alt:0, type:walkerObj.type, owner:walkerObj.owner})
        .done(function(data) {
            var len = data.length;
            alert("getdata");
            for(var i = 0; i < len; i++) {
                log("get data="+data[i].result);
            }
        });
    }
     
    function handleNotifications(event) {
        let value = event.target.value;
        /*
        typedef struct {
        int id;
        float posLati;
        float posLong;
        float angle;
        int type;
        int owner;
        int status;
        int enableFg;
        int viewFg;
        } t_objInfo;*/
        let a = [];
        // Convert raw data bytes to hex values just for the sake of showing something.
        // In the "real" world, you'd use data.getUint8, data.getUint16 or even
        // TextDecoder to process raw data bytes.
        for (let i = 0; i < value.byteLength; i++) {
            //a.push('0x' + ('00' + value.getUint8(i).toString(16)).slice(-2));
            a.push(value.getUint8(i).toString(16));
        }
        log('> notify ' + a.join(' '));
        
        var buffer = new ArrayBuffer(4);
        
        var dataView = new DataView(buffer);
        dataView.setUint8(0, parseInt(value.getUint8(4).toString(16),16));
        dataView.setUint8(1, parseInt(value.getUint8(5).toString(16),16));
        dataView.setUint8(2, parseInt(value.getUint8(6).toString(16),16));
        dataView.setUint8(3, parseInt(value.getUint8(7).toString(16),16));
        var putObjLati = dataView.getFloat32(0, true);
        
        dataView.setUint8(0, parseInt(value.getUint8(8).toString(16),16));
        dataView.setUint8(1, parseInt(value.getUint8(9).toString(16),16));
        dataView.setUint8(2, parseInt(value.getUint8(10).toString(16),16));
        dataView.setUint8(3, parseInt(value.getUint8(11).toString(16),16));
        var putObjLong = dataView.getFloat32(0, true);
        
        dataView.setUint8(0, parseInt(value.getUint8(12).toString(16),16));
        dataView.setUint8(1, parseInt(value.getUint8(13).toString(16),16));
        var putAngle = dataView.getInt16(0, true);
          
        log("covert pos lati="+putObjLati+" long="+putObjLong+ " angle="+putAngle);
    }
  
    function doubleToByteArray(number) {
        var buffer = new ArrayBuffer(8);         // JS numbers are 8 bytes long, or 64 bits
      var longNum = new Float64Array(buffer);  // so equivalent to Float64

        longNum[0] = number;
    
        return Array.from(new Uint8Array(buffer)).reverse();  // reverse to get little endian
    }
  
    window.onload = function (){
    const CANDLE_SERVICE_UUID = 0x00FF;
    
    class PlaybulbCandle {
      constructor() {
        this.device = null;
      }
      
      connect() {
        alert('bb')
        let options = {filters:[{services:[ CANDLE_SERVICE_UUID ]}]};
        return navigator.bluetooth.requestDevice(options)
        .then(function(device) {
              this.device = device;
              }.bind(this));
      }
    }
    window.playbulbCandle = new PlaybulbCandle();
    //window.playbulbCandle.connect();  
  }
  
  </script>
  <script>
    var ChromeSamples = {
      log: function() {
        var line = Array.prototype.slice.call(arguments).map(function(argument) {
                                                             return typeof argument === 'string' ? argument : JSON.stringify(argument);
                                                             }).join(' ');
                                                             
                                                             document.querySelector('#log').textContent += line + '\n';
      },
      
      clearLog: function() {
        document.querySelector('#log').textContent = '';
      },
      
      setStatus: function(status) {
        document.querySelector('#status').textContent = status;
      },
      
      setContent: function(newContent) {
        var content = document.querySelector('#content');
        while(content.hasChildNodes()) {
          content.removeChild(content.lastChild);
        }
        content.appendChild(newContent);
      }
    };
  </script>
  <script>
    log = ChromeSamples.log;
    
    function isWebBluetoothEnabled() {
      if (navigator.bluetooth) {
        return true;
      } else {
        ChromeSamples.setStatus('Web Bluetooth API is not available.\n' +
                                'Please make sure the "Experimental Web Platform features" flag is enabled.');
                                return false;
      }
    }
  </script>
  
  
  <style>
    h4,#txt_result{ width:90%; margin:0 auto; }
    #gmap{ width:90%; height:320px; margin:0 auto; }
  </style>
</head>
<body>
    <div id="gmap">ここに地図</div>
    <h4>　【現在位置】</h4>
    <div id="txt_result">ここに位置情報</div><br>
    
    
    <input type="button" id="test" value="test exec"/><br />
   
    <!-- 
    <select name="myId" id="myId">
        <option value="1">1</option>
        <option value="1">2</option>
    </select>
    -->
    
    <datalist id="myIds">
        <option value="1">11</option>
        <option value="2">2</option>
    </datalist>
    
    <input id="myId" type="text" list="myIds" autofocus placeholder="My ID">
    
    <input type="button" id="ble_connect" value="ble connect"/><br/>
    <input type="button" id="ble_read_test" value="ble read test"/><br/>
    <input type="button" id="ble_write_test" value="ble write test"/><br/>
    <input type="button" id="update_pos" value="update pos"/><br/>
    <input type="button" id="update_obj" value="update obj"/><br/>
    <input type="button" id="ble_disconnect" value="ble disconnect"/><br/>
   
    <form>
        <input id="service" type="text" list="services" autofocus placeholder="Bluetooth Service">
        <input id="characteristic" type="text" list="characteristics" placeholder="Bluetooth Characteristic">
        <input type="button" id="ble_getchar" value="ble getchar"/><br/>
        <!--<button>Get Bluetooth characteristic properties</button>-->
    </form>
  
    <datalist id="services">
        <option value="alert_notification">alert_notification</option>
     </datalist>
   
    <datalist id="characteristics">
        <option value="aerobic_heart_rate_lower_limit">aerobic_heart_rate_lower_limit</option>
        <option value="weight_scale_feature">weight_scale_feature</option>
        <option value="wind_chill">wind_chill</option>
    </datalist>
  
  <h3>Live Output</h3>
  <div id="output" class="output">
    <div id="content"></div>
    <div id="status"></div>
    <pre id="log"></pre>
  </div>
  
</body>
</html>
