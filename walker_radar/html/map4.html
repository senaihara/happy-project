<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset=utf-8>
  <meta name="viewport" content="width=device-width,initial-scale=1.0, user-scalable=yes">
  <title>Html5 位置情報</title>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?callback=initMap" async defer></script>
  <script>
    var g_characteristic = {};
    var g_device = {};
    let g_lati;
    var g_long; 
    
      function initMap() {             // google maps Javascript と同期
        if (navigator.geolocation) {   // 現在の位置情報を取得する
          navigator.geolocation.getCurrentPosition(successCallback, errorCallback,option);
          //navigator.geolocation.getCurrentPosition(successCallback, errorCallback,{enableHighAccuracy: true});
        } else {
          alert('navigator.geolocation は利用出来ません');
        }  
      }; //  initMap()  --------------
      
      // 現在の位置情報を取得時の処置  ------------------
      function successCallback(position) {
        var lati = position.coords.latitude.toFixed(5);
        var long = position.coords.longitude.toFixed(5);
        g_lati = position.coords.latitude.toFixed(5);
        g_long = position.coords.longitude.toFixed(5);
        
        var g_txt = "緯度：" + g_lati + "<br>";
        g_txt += "経度：" + g_long + "<br>";  
        g_txt += "同精度：" + position.coords.accuracy + " m<br>";
        g_txt += "高度：" + position.coords.altitude + " m<br>";
        document.getElementById("txt_result").innerHTML = g_txt; // 位置の書き出し
        // Google Mapsに書き出し ------------------
        var latlng = new google.maps.LatLng( lati,long );        // 地図の中心
        var mapobj = new google.maps.Map( document.getElementById('gmap'), {
            zoom: 15 ,
            center:latlng
        });
        new google.maps.Marker( { map:mapobj , position:latlng } );  // マーカーセット
      }; //  successCallback(position) ---------------
 
      // 位置情報が取得できない場合の処置 ---------------
      function errorCallback(error) {
        var err_msg = "";
        switch(error.code){
          case 0:
            err_msg = "原因不明のエラーが発生しました";
            break;
          case 1:
            err_msg = "位置情報の利用が許可されていません";
            break;
          case 2:
            err_msg = "デバイスの位置が取得できません";
            break;
          case 3:
            err_msg = "タイムアウトしました";
            break;
        }
        document.getElementById("txt_result").innerHTML = err_msg;
      }; //  errorCallback(error) ----------------------
      
      var option =  {                 // 位置取得オプション
            "enableHighAccuracy":true,
            "timeout":8000,
            "maximumAge":60000,
          }

$(function() {
	$('#button').click(function(){
		//alert('auau');
                       $.getJSON('http://160.16.116.250/api/search.php',
                                 {
                                 zipcode: 1
                                 }
                                 )
                       // 結果を取得したら…
                       .done(function(data) {
                             // 中身が空でなければ、その値を［住所］欄に反映
                             
                             //if (data.results) {
                             alert('getdata')
                             //var result = data.results[0];
                             
                             ulObj = $("#output"),
                             len = data.length;
                             
                             for(var i = 0; i < len; i++) {
                             ulObj.append($("<li>").attr({"id":data[i].id}).text(data[i].name));
                             }
                             //$('#address').val(result.address1 + result.address2 + result.address3);
                             // 中身が空の場合は、エラーメッセージを反映
                             
                             });
                       
		// $.getJSON("http://160.16.116.250/api/search.php", function(data){
        //for(var i in data){
       // $("#output").append("<li><strong>" + data[i].id + "</strong></li>");
   //    alert('auau')
  //  }
        
                     });

  $('#ble_getchar').click(function(){
                    alert('ble getchar')
                   let serviceUuid = document.querySelector('#service').value;
                   if (serviceUuid.startsWith('0x')) {
                   serviceUuid = parseInt(serviceUuid);
                   }
                   
                   let characteristicUuid = document.querySelector('#characteristic').value;
                   if (characteristicUuid.startsWith('0x')) {
                   characteristicUuid = parseInt(characteristicUuid);
                   }
                   
                   log('Requesting Bluetooth Device...');
                   navigator.bluetooth.requestDevice({filters: [{services: [serviceUuid]}]})
                   .then(device => {
                         log('Connecting to GATT Server...');
                         return device.gatt.connect();
                         })
                   .then(server => {
                         log('Getting Service...');
                         return server.getPrimaryService(serviceUuid);
                         })
                   .then(service => {
                         log('Getting Characteristic...');
                         return service.getCharacteristic(characteristicUuid);
                         })
                   .then(characteristic => {
                         log('> Characteristic UUID:  ' + characteristic.uuid);
                         log('> Broadcast:            ' + characteristic.properties.broadcast);
                         log('> Read:                 ' + characteristic.properties.read);
                         log('> Write w/o response:   ' +
                             characteristic.properties.writeWithoutResponse);
                         log('> Write:                ' + characteristic.properties.write);
                         log('> Notify:               ' + characteristic.properties.notify);
                         log('> Indicate:             ' + characteristic.properties.indicate);
                         log('> Signed Write:         ' +
                             characteristic.properties.authenticatedSignedWrites);
                         log('> Queued Write:         ' + characteristic.properties.reliableWrite);
                         log('> Writable Auxiliaries: ' +
                             characteristic.properties.writableAuxiliaries);
                         })
                   .catch(error => {
                          log('Argh! ' + error);
                  });
       })
  
    $('#ble_connect').click(function(){
    alert('connect')
                             const SERVICE_UUID =0x0d18;
                            const CHARA_UUID = 0x2a33;
                            navigator.bluetooth.requestDevice({filters: [{services: [SERVICE_UUID]}]})
                            .then(device => {
                                  log('Connecting to GATT Server...');
                                  g_device = device;
                                  return device.gatt.connect();
                                  })
                            .then(server => {
                                  log('Getting Service...');
                                  return server.getPrimaryService(SERVICE_UUID);
                                  })
                            .then(service => {
                                  log('Getting Characteristic...');
                                  return service.getCharacteristic(CHARA_UUID);
                                  })
                            //.then(characteristic => {
                            //    characteristic.startNotifications();
                            //})

                            .then(characteristic => {
                                  log('> Characteristic UUID:  ' + characteristic.uuid);
                                  log('> Broadcast:            ' + characteristic.properties.broadcast);
                                  log('> Read:                 ' + characteristic.properties.read);
                                  log('> Write w/o response:   ' +
                                      characteristic.properties.writeWithoutResponse);
                                  log('> Write:                ' + characteristic.properties.write);
                                  log('> Notify:               ' + characteristic.properties.notify);
                                  log('> Indicate:             ' + characteristic.properties.indicate);
                                  log('> Signed Write:         ' +
                                      characteristic.properties.authenticatedSignedWrites);
                                  log('> Queued Write:         ' + characteristic.properties.reliableWrite);
                                  log('> Writable Auxiliaries: ' +
                                      characteristic.properties.writableAuxiliaries);
                                  
                                  g_characteristic = characteristic;
                               //   g_characteristic.startNotifications().then(_ => {
                                //     log('> Notifications started');
                                 //     g_characteristic.addEventListener('characteristicvaluechanged',
                                  //      handleNotifications);
                                  //   });
                                    return g_characteristic.startNotifications().then(_ => {
     log('> Notifications started');
      g_characteristic.addEventListener('characteristicvaluechanged',
          handleNotifications);
    });
                                    
                                  })
                            
                            })
  
  $('#ble_read_test').click(function(){
     alert("read test");
                       g_characteristic.readValue()
                       .then((val) => {
                             let ble_value = val.getUint8(0)
                             log('> Characteristic value:  ' + ble_value)
                             

                             
                             })
                     
  
     
                       
    
                                            })
     $('#ble_write_test').click(function(){
     alert("write test");
                    var barr = new Int8Array(1);
                    barr[0]=2;
                      g_characteristic.writeValue(barr);  
     
                       
    
                                            })
   
                                            
        $('#update_pos').click(function(){
           //   let resetEnergyExpended = new Uint8Array([1]);
             
            
             var f32 = new Float32Array(1);
            f32[0] = g_lati;
            log(g_lati+" "+f32[0]);
            
             var barr = new Int8Array(f32.buffer)
            g_characteristic.writeValue(barr);
       return;
            //g_characteristic.writeValue(resetEnergyExpended);
       
            
            log("array length="+array.length);
            for(var i =0; i<array.length; i++){
                log(array[i]);
            }
            var buffer = new ArrayBuffer(8);
            for(var i =0; i<array.length; i++){
                buffer[i] = 1;
            }
            var dataview = new DataView(buffer);
            for(var i =0; i<array.length; i++){
                dataview.setUint8(i, array[i]);
            }
            
            log("convert pos="+dataview.getFloat64(0));
            //g_device.gatt.disconnect()
    })
                                            
                                            
  $('#ble_disconnect').click(function(){
                            alert('disconnect')
                       g_device.gatt.disconnect()
                       
                       })
  

  
  
  
  });
  
  function handleNotifications(event) {
  let value = event.target.value;
  let a = [];
  // Convert raw data bytes to hex values just for the sake of showing something.
  // In the "real" world, you'd use data.getUint8, data.getUint16 or even
  // TextDecoder to process raw data bytes.
  for (let i = 0; i < value.byteLength; i++) {
    a.push('0x' + ('00' + value.getUint8(i).toString(16)).slice(-2));
  }
  log('> notify ' + a.join(' '));
}
  
  function doubleToByteArray(number) {
    var buffer = new ArrayBuffer(8);         // JS numbers are 8 bytes long, or 64 bits
    var longNum = new Float64Array(buffer);  // so equivalent to Float64

    longNum[0] = number;

    return Array.from(new Uint8Array(buffer)).reverse();  // reverse to get little endian
}
  
  window.onload = function (){
    //alert('aa')
    const CANDLE_SERVICE_UUID = 0x00FF;
    
    
    class PlaybulbCandle {
      constructor() {
        this.device = null;
      }
      connect() {
        alert('bb')
        let options = {filters:[{services:[ CANDLE_SERVICE_UUID ]}]};
        return navigator.bluetooth.requestDevice(options)
        .then(function(device) {
              this.device = device;
              }.bind(this));
      }
    }
    window.playbulbCandle = new PlaybulbCandle();
    //window.playbulbCandle.connect();

    
  }
  
  </script>
  <script>
    var ChromeSamples = {
      log: function() {
        var line = Array.prototype.slice.call(arguments).map(function(argument) {
                                                             return typeof argument === 'string' ? argument : JSON.stringify(argument);
                                                             }).join(' ');
                                                             
                                                             document.querySelector('#log').textContent += line + '\n';
      },
      
      clearLog: function() {
        document.querySelector('#log').textContent = '';
      },
      
      setStatus: function(status) {
        document.querySelector('#status').textContent = status;
      },
      
      setContent: function(newContent) {
        var content = document.querySelector('#content');
        while(content.hasChildNodes()) {
          content.removeChild(content.lastChild);
        }
        content.appendChild(newContent);
      }
    };
  </script>
  <script>
    log = ChromeSamples.log;
    
    function isWebBluetoothEnabled() {
      if (navigator.bluetooth) {
        return true;
      } else {
        ChromeSamples.setStatus('Web Bluetooth API is not available.\n' +
                                'Please make sure the "Experimental Web Platform features" flag is enabled.');
                                return false;
      }
    }
  </script>
  
  
  <style>
    h4,#txt_result{ width:90%; margin:0 auto; }
    #gmap{ width:90%; height:320px; margin:0 auto; }
  </style>
</head>
<body>
  <div id="gmap">ここに地図</div>
<h4>　【現在位置】</h4>
  <div id="txt_result">ここに位置情報</div><br>
<input type="button" id="button" value="Exec"/><br />
  <div id="output"></div>
    <input type="button" id="ble_connect" value="ble connect"/><br/>
    <input type="button" id="ble_read_test" value="ble read test"/><br/>
    <input type="button" id="ble_write_test" value="ble write test"/><br/>
    
    <input type="button" id="update_pos" value="update pos"/><br/>
     <input type="button" id="ble_disconnect" value="ble disconnect"/><br/>
  <form>
    <input id="service" type="text" list="services" autofocus placeholder="Bluetooth Service">
      <input id="characteristic" type="text" list="characteristics" placeholder="Bluetooth Characteristic">
        <input type="button" id="ble_getchar" value="ble getchar"/><br/>
        <!--<button>Get Bluetooth characteristic properties</button>-->
  </form>
  
  <datalist id="services">
    <option value="alert_notification">alert_notification</option>
  </datalist>
  
  <datalist id="characteristics">
    <option value="aerobic_heart_rate_lower_limit">aerobic_heart_rate_lower_limit</option>
    <option value="weight_scale_feature">weight_scale_feature</option>
    <option value="wind_chill">wind_chill</option>
  </datalist>
  
  <h3>Live Output</h3>
  <div id="output" class="output">
    <div id="content"></div>
    <div id="status"></div>
    <pre id="log"></pre>
  </div>
  
</body>
</html>
